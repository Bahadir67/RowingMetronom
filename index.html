<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowing Metronome</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        h1 {
            color: #2c3e50;
        }
        .form-group {
            margin: 10px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
        }
        #progressBarContainer {
            width: 100%;
            height: 30px;
            background-color: #f3f3f3;
            margin-top: 20px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        #progressBar {
            height: 100%;
            width: 0%;
            position: absolute;
            border-radius: 15px;
        }
        #timerAndStroke {
            font-size: 1.5em;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Rowing Metronome</h1>
    <div id="settings">
        <div class="form-group">
            <label for="spm">SPM (Stroke Per Minute - Dakikadaki Çekiş):</label>
            <input type="number" step="0.1" id="spm" placeholder="Dakikadaki Çekiş Sayısı" value="21">
        </div>
        <div class="form-group">
            <label for="ratio">Drive:Recovery Oranı:</label>
            <input type="text" id="ratio" placeholder="Örneğin 1:2" value="1:2">
        </div>
        <div class="form-group">
            <label for="driveTime">Drive Süresi (saniye):</label>
            <input type="number" step="0.1" id="driveTime" placeholder="SPM girerseniz otomatik hesaplanır">
            <input type="checkbox" id="driveSoundEnable" checked>
        </div>
        <div class="form-group">
            <label for="recoveryTime">Recovery Süresi (saniye):</label>
            <input type="number" step="0.1" id="recoveryTime" placeholder="SPM girerseniz otomatik hesaplanır">
            <input type="checkbox" id="recoverySoundEnable" checked>
        </div>
        <button id="startButton">Başlat</button>
    </div>
    <div id="progressBarContainer">
        <div id="progressBar"></div>
    </div>
    <div id="timerAndStroke">
        <span id="lastStrokeTime">Son Stroke Süresi: 0 saniye</span><br>
        <span id="elapsedTime">Geçen Süre: 0 saniye</span> | <span id="strokeCount">Çekiş Sayısı: 0</span>
    </div>
    <h2 id="status">Durum: Hazır</h2>

    <script>
        const startButton = document.getElementById('startButton');
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progressBar');
        const lastStrokeTimeDisplay = document.getElementById('lastStrokeTime');
        const elapsedTimeDisplay = document.getElementById('elapsedTime');
        const strokeCountDisplay = document.getElementById('strokeCount');

        // Girdi elementlerini tanımlıyoruz
        const spmInput = document.getElementById('spm');
        const ratioInput = document.getElementById('ratio');
        const driveTimeInput = document.getElementById('driveTime');
        const recoveryTimeInput = document.getElementById('recoveryTime');
        const driveSoundEnableCheckbox = document.getElementById('driveSoundEnable');
        const recoverySoundEnableCheckbox = document.getElementById('recoverySoundEnable');

        // Ses dosyalarını tanımlıyoruz
        const catchSound = new Audio('./sounds/start.mp3'); // Catch fazı için yeni ses dosyası
        const finishSound = new Audio('./sounds/stop.mp3'); // Finish fazı için önceki ses dosyası
        const driveSound = new Audio('./sounds/drive.mp3');
        const recoverySound = new Audio('./sounds/recovery.mp3');

        let isRunning = false; // Döngünün çalışıp çalışmadığını kontrol eder
        let currentPhase = 0; // Şu anki fazı tutar
        let timeoutId = null; // Faz zamanlayıcısını tutar
        let intervalId = null; // Zamanlayıcıyı güncellemek için
        let strokeCount = 0; // Toplam çekiş sayısını tutar
        let totalElapsedTime = 0; // Başlangıçtan itibaren geçen süre

        const stopAllSounds = () => {
            // Tüm sesleri durdur ve başa sar
            [catchSound, finishSound, driveSound, recoverySound].forEach(sound => {
                sound.pause();
                sound.currentTime = 0;
            });
        };

        const phases = [];

        const updateValues = (trigger) => {
            const spm = parseFloat(spmInput.value);
            const ratio = ratioInput.value.split(':').map(Number);
            const driveRatio = ratio[0];
            const recoveryRatio = ratio[1];
            const totalRatio = driveRatio + recoveryRatio;

            if (spm && totalRatio) {
                const totalStrokeTime = (60 / spm) * 1000; // Toplam stroke süresi milisaniye cinsinden
                const catchAndFinishTotal = 1000; // Catch ve Finish toplam süresi (1000 ms)
                const remainingTime = totalStrokeTime - catchAndFinishTotal; // Kalan süre (Drive ve Recovery için)

                const driveTime = (remainingTime * driveRatio) / totalRatio;
                const recoveryTime = (remainingTime * recoveryRatio) / totalRatio;
                driveTimeInput.value = (driveTime / 1000).toFixed(2);
                recoveryTimeInput.value = (recoveryTime / 1000).toFixed(2);
            }
        };

        // Girdi elemanlarına event listener ekleyerek her değişiklikte diğerlerini güncelleme
        spmInput.addEventListener('input', () => {
            updateValues('spm');
        });

        ratioInput.addEventListener('input', () => {
            updateValues('ratio');
        });

        driveTimeInput.addEventListener('input', () => {
            updateValues('drive');
        });

        recoveryTimeInput.addEventListener('input', () => {
            updateValues('recovery');
        });

        // Sayfa yüklendiğinde başlangıç değerlerini hesapla
        window.addEventListener('load', () => {
            updateValues('spm');
        });

        const updateElapsedTime = () => {
            clearInterval(intervalId);
            intervalId = setInterval(() => {
                if (isRunning) {
                    totalElapsedTime += 0.1;
                    elapsedTimeDisplay.textContent = `Geçen Süre: ${totalElapsedTime.toFixed(1)} saniye`;
                }
            }, 100);
        };

        const playPhase = () => {
            if (!isRunning) return; // Çalışma durdurulduysa devam etme

            if (currentPhase >= phases.length) {
                currentPhase = 0; // Döngü başa dönsün
                strokeCount++; // Her tur tamamlandığında çekiş sayısını artır
                strokeCountDisplay.textContent = `Çekiş Sayısı: ${strokeCount}`;
            }

            const phase = phases[currentPhase];
            status.textContent = `Durum: ${phase.name}`;

            // Fazın sesini başlatmadan önce tüm sesleri durdur
            stopAllSounds();

            // Fazın adına göre ilgili sesi oynat
            if (phase.name === 'Drive' && driveSoundEnableCheckbox.checked) {
                driveSound.play().catch((error) => console.error(`${phase.name} sesi çalınamadı:`, error));
            } else if (phase.name === 'Recovery' && recoverySoundEnableCheckbox.checked) {
                recoverySound.play().catch((error) => console.error(`${phase.name} sesi çalınamadı:`, error));
            } else if (phase.name === 'Catch') {
                catchSound.play().catch((error) => console.error(`${phase.name} sesi çalınamadı:`, error));
            } else if (phase.name === 'Finish') {
                finishSound.play().catch((error) => console.error(`${phase.name} sesi çalınamadı:`, error));
            }

            // Progress bar'ı kontrol et
            if (phase.name === 'Drive') {
                progressBar.style.backgroundColor = 'red';
                progressBar.style.transition = `width ${phase.duration / 1000}s linear`;
                progressBar.style.width = '0%';
                setTimeout(() => {
                    progressBar.style.width = '100%';
                }, 50);
            } else if (phase.name === 'Recovery') {
                progressBar.style.backgroundColor = 'green';
                progressBar.style.transition = `width ${phase.duration / 1000}s linear`;
                progressBar.style.width = '100%';
                setTimeout(() => {
                    progressBar.style.width = '0%';
                }, 50);
            }

            // Mevcut faz tamamlandıktan sonra bir sonraki faza geç
            timeoutId = setTimeout(() => {
                currentPhase++;
                playPhase();
            }, phase.duration);
        };

        startButton.addEventListener('click', () => {
            if (isRunning) {
                // Metronomu durdur
                clearTimeout(timeoutId);
                clearInterval(intervalId);
                stopAllSounds();
                isRunning = false;
                status.textContent = "Durum: Durduruldu";
                startButton.textContent = "Başlat";
                progressBar.style.width = '0%';
                progressBar.style.transition = 'none';
                return;
            }

            // Metronomu başlat
            isRunning = true;
            startButton.textContent = "Durdur";

            // Başlangıç anından itibaren geçen süreyi sıfırla ve zamanlayıcıyı başlat
            totalElapsedTime = 0;
            strokeCount = 0; // Çekiş sayısını sıfırla
            elapsedTimeDisplay.textContent = "Geçen Süre: 0 saniye";
            strokeCountDisplay.textContent = "Çekiş Sayısı: 0";
            updateElapsedTime();

            // Faz sürelerini al ve fazları güncelle
            const catchTime = 500; // Catch süresi sabit 0.5 saniye (500 ms)
            const driveTime = parseFloat(driveTimeInput.value) * 1000;
            const finishTime = 500; // Finish süresi sabit 0.5 saniye (500 ms)
            const recoveryTime = parseFloat(recoveryTimeInput.value) * 1000;

            phases.length = 0; // Eski fazları temizle
            phases.push(
                { name: 'Catch', duration: catchTime, sound: catchSound },
                { name: 'Drive', duration: driveTime, sound: driveSound },
                { name: 'Finish', duration: finishTime, sound: finishSound },
                { name: 'Recovery', duration: recoveryTime, sound: recoverySound }
            );

            status.textContent = 'Durum: Başlıyor...';
            currentPhase = 0; // İlk fazdan başla
            playPhase();
        });
    </script>
</body>
</html>
