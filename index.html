<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowing Metronome</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        h1 {
            color: #2c3e50;
        }
        .form-group {
            margin: 10px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
        }
        #progressBarContainer {
            width: 100%;
            height: 30px;
            background-color: #f3f3f3;
            margin-top: 20px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        #progressBar {
            height: 100%;
            width: 0%;
            position: absolute;
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <h1>Rowing Metronome</h1>
    <div id="settings">
        <div class="form-group">
            <label>SPM (Stroke Per Minute - Dakikadaki Çekiş):</label>
            <input type="number" step="0.1" id="spm" placeholder="Dakikadaki Çekiş Sayısı" value="23">
        </div>
        <div class="form-group">
            <label>Drive Süresi (saniye):</label>
            <input type="number" step="0.1" id="driveTime" placeholder="SPM girerseniz otomatik hesaplanır">
        </div>
        <div class="form-group">
            <label>Recovery Süresi (saniye):</label>
            <input type="number" step="0.1" id="recoveryTime" placeholder="SPM girerseniz otomatik hesaplanır">
        </div>
        <button id="startButton">Başlat</button>
    </div>
    <div id="progressBarContainer">
        <div id="progressBar"></div>
    </div>
    <h2 id="status">Durum: Hazır</h2>

    <script>
        const startButton = document.getElementById('startButton');
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progressBar');

        // Ses dosyalarını tanımlıyoruz
        const catchAndFinishSound = new Audio('./sounds/stop.mp3');
        const driveSound = new Audio('./sounds/drive.mp3');
        const recoverySound = new Audio('./sounds/recovery.mp3');

        let isRunning = false; // Döngünün çalışıp çalışmadığını kontrol eder
        let currentPhase = 0; // Şu anki fazı tutar
        let timeoutId = null; // Faz zamanlayıcısını tutar

        const stopAllSounds = () => {
            // Tüm sesleri durdur ve başa sar
            [catchAndFinishSound, driveSound, recoverySound].forEach(sound => {
                sound.pause();
                sound.currentTime = 0;
            });
        };

        const phases = [];

        const updateDriveRecoveryValues = () => {
            const spm = parseFloat(document.getElementById('spm').value);
            if (spm) {
                const totalStrokeTime = (60 / spm) * 1000; // SPM'den bir stroğun toplam süresi (ms cinsinden)
                const driveTimeInput = document.getElementById('driveTime');
                const recoveryTimeInput = document.getElementById('recoveryTime');

                let driveTime = parseFloat(driveTimeInput.value) * 1000;
                let recoveryTime = parseFloat(recoveryTimeInput.value) * 1000;

                if (driveTime && driveTime < totalStrokeTime) {
                    recoveryTime = totalStrokeTime - driveTime;
                    recoveryTimeInput.value = (recoveryTime / 1000).toFixed(2);
                } else if (recoveryTime && recoveryTime < totalStrokeTime) {
                    driveTime = totalStrokeTime - recoveryTime;
                    driveTimeInput.value = (driveTime / 1000).toFixed(2);
                } else {
                    // Eşit olarak bölüştür
                    driveTime = 0.5 * totalStrokeTime;
                    recoveryTime = 0.5 * totalStrokeTime;
                    driveTimeInput.value = (driveTime / 1000).toFixed(2);
                    recoveryTimeInput.value = (recoveryTime / 1000).toFixed(2);
                }
            }
        };

        document.getElementById('spm').addEventListener('input', () => {
            updateDriveRecoveryValues();
        });

        document.getElementById('driveTime').addEventListener('input', () => {
            updateDriveRecoveryValues();
        });

        document.getElementById('recoveryTime').addEventListener('input', () => {
            updateDriveRecoveryValues();
        });

        // Sayfa yüklendiğinde başlangıç değerlerini hesapla
        window.addEventListener('load', () => {
            updateDriveRecoveryValues();
        });

        const playPhase = () => {
            if (!isRunning) return; // Çalışma durdurulduysa devam etme

            if (currentPhase >= phases.length) {
                currentPhase = 0; // Döngü başa dönsün
            }

            const phase = phases[currentPhase];
            status.textContent = `Durum: ${phase.name}`;

            // Fazın sesini başlatmadan önce tüm sesleri durdur
            stopAllSounds();
            phase.sound.play().catch((error) => console.error(`${phase.name} sesi çalınamadı:`, error));

            // Progress bar'ı kontrol et
            if (phase.name === 'Drive') {
                progressBar.style.backgroundColor = 'red';
                progressBar.style.transition = `width ${phase.duration / 1000}s linear`;
                progressBar.style.width = '0%';
                setTimeout(() => {
                    progressBar.style.width = '100%';
                }, 50);
            } else if (phase.name === 'Recovery') {
                progressBar.style.backgroundColor = 'green';
                progressBar.style.transition = `width ${phase.duration / 1000}s linear`;
                progressBar.style.width = '0%';
                setTimeout(() => {
                    progressBar.style.width = '100%';
                }, 50);
            }
            // Mevcut faz tamamlandıktan sonra bir sonraki faza geç
            timeoutId = setTimeout(() => {
                currentPhase++;
                playPhase();
            }, phase.duration);
        };

        startButton.addEventListener('click', () => {
            if (isRunning) {
                // Metronomu durdur
                clearTimeout(timeoutId);
                stopAllSounds();
                isRunning = false;
                status.textContent = "Durum: Durduruldu";
                startButton.textContent = "Başlat";
                progressBar.style.width = '0%';
                progressBar.style.transition = 'none';
                return;
            }

            // Metronomu başlat
            isRunning = true;
            startButton.textContent = "Durdur";

            // Faz sürelerini al ve fazları güncelle
            const catchTime = 500; // Catch süresi sabit 0.5 saniye (500 ms)
            const driveTime = parseFloat(document.getElementById('driveTime').value) * 1000;
            const finishTime = 500; // Finish süresi sabit 0.5 saniye (500 ms)
            const recoveryTime = parseFloat(document.getElementById('recoveryTime').value) * 1000;

            phases.length = 0; // Eski fazları temizle
            phases.push(
                { name: 'Catch', duration: catchTime, sound: catchAndFinishSound },
                { name: 'Drive', duration: driveTime, sound: driveSound },
                { name: 'Finish', duration: finishTime, sound: catchAndFinishSound },
                { name: 'Recovery', duration: recoveryTime, sound: recoverySound }
            );

            status.textContent = 'Durum: Başlıyor...';
            currentPhase = 0; // İlk fazdan başla
            playPhase();
        });
    </script>
</body>
</html>
